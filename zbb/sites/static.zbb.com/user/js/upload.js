!function($){$(function(){function e(e){var a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),t=$('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo(a),i=a.find("p.progress span"),r=a.find("p.imgWrap"),l=$('<p class="error"></p>'),d=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}l.text(text).appendTo(a)};"invalid"===e.getStatus()?d(e.statusText):(r.text("预览中"),s.makeThumb(e,function(e,a){var t;return e?void r.text("不能预览"):void(h?(t=$('<img src="'+a+'">'),r.empty().append(t)):$.ajax("../../server/preview.php",{method:"POST",data:a,dataType:"json"}).done(function(e){e.result?(t=$('<img src="'+e.result+'">'),r.empty().append(t)):r.text("预览出错")}))},p,u),f[e.id]=[e.size,0],e.rotation=0),e.on("statuschange",function(s,r){"progress"===r?i.hide().width(0):"queued"===r&&(a.off("mouseenter mouseleave"),t.remove()),"error"===s||"invalid"===s?(d(e.statusText),f[e.id][1]=1):"interrupt"===s?d("interrupt"):"queued"===s?f[e.id][1]=0:"progress"===s?(l.remove(),i.css("display","block")):"complete"===s&&a.append('<span class="success"></span>'),a.removeClass("state-"+r).addClass("state-"+s)}),a.on("mouseenter",function(){t.stop().animate({height:30})}),a.on("mouseleave",function(){t.stop().animate({height:0})}),t.on("click","span",function(){var a,t=$(this).index();switch(t){case 0:return void s.removeFile(e);case 1:break;case 2:}v?(a="rotate("+e.rotation+"deg)",r.css({"-webkit-transform":a,"-mos-transform":a,"-o-transform":a,transform:a})):r.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),a.appendTo(o),n.show()}function a(e){var a=$("#"+e.id);delete f[e.id],a.off().find(".file-panel").off().end().remove()}function t(e){var a;if(e!==m)switch(n.removeClass("state-"+m),n.addClass("state-"+e),m=e){case"pedding":o.hide(),s.refresh();break;case"ready":o.show(),s.refresh();break;case"uploading":n.text("暂停上传");break;case"paused":n.text("继续上传");break;case"confirm":if(n.text("开始上传"),a=s.getStats(),a.successNum&&!a.uploadFailNum)return void t("finish");break;case"finish":if(a=s.getStats(),a.successNum){alert("上传成功");var i=$("#WU_FILE_0 img").attr("src");$("#big_goods_image").attr("src",i)}else m="done",location.reload()}}function i(){for(var e=$("#uploadimg").val().split(","),a="http://img."+window.location.href.split(".")[1]+".com/",t=0;t<e.length;t++)$(".filelist li").eq(t).data("img",e[t]),$(".filelist img").eq(t).attr("src",a+e[t]);$("#big_goods_image").attr("src",a+e[0])}var s,r=$("#uploader"),o=$("#uploader .filelist"),n=r.find(".uploadBtn"),l=3,d=0,c=window.devicePixelRatio||1,p=300*c,u=300*c,m="pedding",f={},h=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),g=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(t){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),v=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}();return!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie?void(g?!function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var a="./expressInstall.swf",t='<object type="application/x-shockwave-flash" data="'+a+'" ';WebUploader.browser.ie&&(t+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),t+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+a+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(t)}(r):r.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')):WebUploader.Uploader.support()?(s=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"/Uploader.swf?var="+(new Date).getTime(),chunked:!1,chunkSize:524288,server:"/goods/upload_more",fileNumLimit:5,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},disableGlobalDnd:!0,fileSizeLimit:2097152,fileSingleSizeLimit:409600}),s.on("ready",function(){window.uploader=s}),s.onFileQueued=function(a){l++,d+=a.size,e(a),t("ready")},s.onFileDequeued=function(e){l--,d-=e.size,l||t("pedding"),a(e)},s.on("all",function(e){switch(e){case"uploadFinished":t("confirm");break;case"startUpload":t("uploading");break;case"stopUpload":t("paused")}}),s.onError=function(e){alert("Eroor: "+e)},s.onUploadSuccess=function(e,a){var t=$("#uploadimg").val();t.length<1?$("#uploadimg").val(a.data):$("#uploadimg").val(t+","+a.data)},n.on("click",function(){return!$(this).hasClass("disabled")&&void("ready"===m?s.upload():"paused"===m?s.upload():"uploading"===m&&s.stop())}),n.addClass("state-"+m),$(".J-del").on("click",function(){var e=$(this).parents("li").data("img"),a=$("#uploadimg").val().split(","),t=a.mateFruit(e);a.splice(t,1),$("#uploadimg").val(a),$(this).parents("li").remove()}),void $(".filelist").on("click",".next,.prev",function(){var e=$(this).parents("li").data("img"),a=$("#uploadimg").val().split(","),t=a.mateFruit(e),s=$(".filelist li").length;return a.length!=s?(alert("数据异常，请提交保存或刷新当前页面再尝试操作！"),!1):(a.length>=2&&($(this).hasClass("prev")?a=a.upRecord(t):$(this).hasClass("next")&&(a=a.downRecord(t))),$("#uploadimg").val(a),void i())})):void alert("您的浏览器不支持本系统的图片上传功能！")}),Array.prototype.mateFruit=function(e){for(i=0;i<this.length;i++)if(this[i]==e)return i;return!1};var e=function(e,a,t){return e[a]=e.splice(t,1,e[a])[0],e};Array.prototype.upRecord=function(a){return 0==a?this:e(this,a,a-1)},Array.prototype.downRecord=function(a){return a==this.length-1?this:e(this,a,a+1)}}(jQuery);