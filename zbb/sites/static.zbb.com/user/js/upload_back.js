!function($){$(function(){function e(e){var a=$('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),t=$('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(a),i=a.find("p.progress span"),o=a.find("p.imgWrap"),n=$('<p class="error"></p>'),l=function(e){switch(e){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}n.text(text).appendTo(a)};"invalid"===e.getStatus()?l(e.statusText):(o.text("预览中"),uploader.makeThumb(e,function(e,a){var t;return e?void o.text("不能预览"):void(isSupportBase64?(t=$('<img src="'+a+'">'),o.empty().append(t)):$.ajax("../../server/preview.php",{method:"POST",data:a,dataType:"json"}).done(function(e){e.result?(t=$('<img src="'+e.result+'">'),o.empty().append(t)):o.text("预览出错")}))},thumbnailWidth,thumbnailHeight),percentages[e.id]=[e.size,0],e.rotation=0),e.on("statuschange",function(s,r){"progress"===r?i.hide().width(0):"queued"===r&&(a.off("mouseenter mouseleave"),t.remove()),"error"===s||"invalid"===s?(l(e.statusText),percentages[e.id][1]=1):"interrupt"===s?l("interrupt"):"queued"===s?percentages[e.id][1]=0:"progress"===s?(n.remove(),i.css("display","block")):"complete"===s&&a.append('<span class="success"></span>'),a.removeClass("state-"+r).addClass("state-"+s)}),a.on("mouseenter",function(){t.stop().animate({height:30})}),a.on("mouseleave",function(){t.stop().animate({height:0})}),t.on("click","span",function(){var a,t=$(this).index();switch(t){case 0:return void uploader.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}supportTransition?(a="rotate("+e.rotation+"deg)",o.css({"-webkit-transform":a,"-mos-transform":a,"-o-transform":a,transform:a})):o.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),a.appendTo(s),r.show()}function a(e){var a=$("#"+e.id);delete percentages[e.id],a.off().find(".file-panel").off().end().remove()}function t(e){var a;if(e!==state)switch(r.removeClass("state-"+state),r.addClass("state-"+e),state=e,state){case"pedding":s.hide(),uploader.refresh();break;case"ready":s.show(),uploader.refresh();break;case"uploading":r.text("暂停上传");break;case"paused":r.text("继续上传");break;case"confirm":if(r.text("开始上传"),a=uploader.getStats(),a.successNum&&!a.uploadFailNum)return void t("finish");break;case"finish":if(a=uploader.getStats(),a.successNum){alert("上传成功");var i=$("#WU_FILE_0 img").attr("src");$("#big_goods_image").attr("src",i)}else state="done",location.reload()}}var i=$("#uploader"),s=$("#uploader .filelist"),r=i.find(".uploadBtn"),o=3;return fileSize=0,ratio=window.devicePixelRatio||1,thumbnailWidth=300*ratio,thumbnailHeight=300*ratio,state="pedding",percentages={},isSupportBase64=function(){var e=new Image,a=!0;return e.onload=e.onerror=function(){1==this.width&&1==this.height||(a=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a}(),flashVersion=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(a){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(t){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),supportTransition=function(){var e=document.createElement("p").style,a="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,a}(),uploader,!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie?void(flashVersion?!function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！")}delete window.expressinstallcallback};var a="./expressInstall.swf",t='<object type="application/x-shockwave-flash" data="'+a+'" ';WebUploader.browser.ie&&(t+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),t+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+a+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(t)}(i):i.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')):WebUploader.Uploader.support()?(uploader=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"/Uploader.swf?var="+(new Date).getTime(),chunked:!1,chunkSize:524288,server:"/refund/upload_more",fileNumLimit:5,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},disableGlobalDnd:!0,fileSizeLimit:2097152,fileSingleSizeLimit:409600}),uploader.on("ready",function(){window.uploader=uploader}),uploader.onFileQueued=function(a){o++,fileSize+=a.size,e(a),t("ready")},uploader.onFileDequeued=function(e){o--,fileSize-=e.size,o||t("pedding"),a(e)},uploader.on("all",function(e){switch(e){case"uploadFinished":t("confirm");break;case"startUpload":t("uploading");break;case"stopUpload":t("paused")}}),uploader.onError=function(e){alert("Eroor: "+e)},uploader.onUploadSuccess=function(e,a){var t=$("#uploadimg").val();t.length<1?$("#uploadimg").val(a.data):$("#uploadimg").val(t+","+a.data)},r.on("click",function(){return!$(this).hasClass("disabled")&&void("ready"===state?uploader.upload():"paused"===state?uploader.upload():"uploading"===state&&uploader.stop())}),r.addClass("state-"+state),void $(".J-del").on("click",function(){var e=$(this).parents("li").data("img"),a=$("#uploadimg").val().split(","),t=a.mateFruit(e);a.splice(t,1),$("#uploadimg").val(a),$(this).parents("li").remove()})):void alert("您的浏览器不支持本系统的图片上传功能！")}),Array.prototype.mateFruit=function(e){for(i=0;i<this.length;i++)if(this[i]==e)return i;return!1}}(jQuery);